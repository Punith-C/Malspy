package com.example.malwareapp;

import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.widget.Button;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import com.android.volley.RequestQueue;
import com.android.volley.toolbox.Volley;

import java.nio.charset.StandardCharsets;

public class O5AnalysisActivity extends AppCompatActivity {

    TextView headerText;
    ProgressBar progressBar;
    Button runBtn;
    String analysisType, appName, packageName, apkUriStr;
    RequestQueue queue;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_analysis);

        headerText = findViewById(R.id.headerText);
        progressBar = findViewById(R.id.progressBar);
        runBtn = findViewById(R.id.runBtn);

        queue = Volley.newRequestQueue(this);

        analysisType = getIntent().getStringExtra("analysisType");
        appName = getIntent().getStringExtra("appName");
        packageName = getIntent().getStringExtra("packageName");
        apkUriStr = getIntent().getStringExtra("apkUri");

        headerText.setText("App: " + (appName != null ? appName : "APK") +
                "\nAnalysis Type: " + analysisType.toUpperCase());

        runBtn.setOnClickListener(v -> runAnalysis());
    }

    private void runAnalysis() {
        progressBar.setVisibility(android.view.View.VISIBLE);
        runBtn.setEnabled(false);

        String url = MainActivity.BASE_URL + "analyze/";

        switch (analysisType.toLowerCase()) {
            case "static":
                url += "static";
                break;
            case "dynamic":
                url += "dynamic";
                break;
            case "hybrid":
                url += "hybrid";
                break;
            default:
                showError("Invalid analysis type: " + analysisType);
                return;
        }

        if (apkUriStr != null) {
            Uri apkUri = Uri.parse(apkUriStr);
            Utils.uploadApk(queue, this, url, apkUri,
                    response -> {
                        String json = new String(response.data, StandardCharsets.UTF_8).trim();
                        openResultActivity(json);
                    },
                    error -> showError("Upload error: " + error.toString()));
        } else if (packageName != null) {
            Utils.uploadInstalledApp(queue, url, packageName, this,
                    response -> {
                        String json = new String(response.data, StandardCharsets.UTF_8).trim();
                        openResultActivity(json);
                    },
                    error -> showError("Upload error: " + error.toString()));
        } else {
            showError("No APK or installed app selected!");
        }
    }

    private void openResultActivity(String json) {
        progressBar.setVisibility(android.view.View.GONE);
        runBtn.setEnabled(true);

        if (!json.startsWith("{") && !json.startsWith("[")) {
            showError("Server returned invalid response:\n" + json);
            return;
        }

        Intent intent = new Intent(this, O6ResultActivity.class);
        intent.putExtra("resultJson", json);
        intent.putExtra("appName", appName);
        intent.putExtra("analysisType", analysisType);
        startActivity(intent);
        finish();
    }

    private void showError(String msg) {
        progressBar.setVisibility(android.view.View.GONE);
        runBtn.setEnabled(true);
        Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
    }
}
