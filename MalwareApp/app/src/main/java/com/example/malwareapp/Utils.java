package com.example.malwareapp;

import android.content.ContentResolver;
import android.content.Context;
import android.net.Uri;

import com.android.volley.DefaultRetryPolicy;
import com.android.volley.RequestQueue;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;

public class Utils {

    // Read APK bytes from Uri (works for content:// and file://)
    public static byte[] readUriToBytes(Context context, Uri uri) throws Exception {
        ContentResolver resolver = context.getContentResolver();
        InputStream is = resolver.openInputStream(uri);
        if (is == null) throw new Exception("Cannot open URI");

        ByteArrayOutputStream buffer = new ByteArrayOutputStream();
        byte[] data = new byte[1024 * 1024]; // 1MB buffer
        int nRead;
        while ((nRead = is.read(data, 0, data.length)) != -1) {
            buffer.write(data, 0, nRead);
        }
        is.close();
        return buffer.toByteArray();
    }

    // Upload APK from Uri
    public static void uploadApk(RequestQueue queue, Context context, String url, Uri apkUri,
                                 VolleyMultipartRequest.Listener listener,
                                 VolleyMultipartRequest.ErrorListener errorListener) {
        try {
            byte[] bytes = readUriToBytes(context, apkUri);

            VolleyMultipartRequest request = new VolleyMultipartRequest(
                    url, bytes, "file", "app.apk", listener, errorListener
            );

            // ⏰ Set timeout to 10 minutes
            request.setRetryPolicy(new DefaultRetryPolicy(
                    600000, // 600 sec = 10 min
                    0, // no retries
                    DefaultRetryPolicy.DEFAULT_BACKOFF_MULT
            ));

            queue.add(request);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // Upload installed APK
    public static void uploadInstalledApp(RequestQueue queue, String url, String packageName, Context context,
                                          VolleyMultipartRequest.Listener listener,
                                          VolleyMultipartRequest.ErrorListener errorListener) {
        try {
            String sourceDir = context.getPackageManager()
                    .getApplicationInfo(packageName, 0).sourceDir;

            if (sourceDir != null) {
                byte[] bytes = readUriToBytes(context, Uri.fromFile(new java.io.File(sourceDir)));

                VolleyMultipartRequest request = new VolleyMultipartRequest(
                        url, bytes, "file", packageName + ".apk", listener, errorListener
                );

                // ⏰ Set timeout to 10 minutes
                request.setRetryPolicy(new DefaultRetryPolicy(
                        600000, // 600 sec = 10 min
                        0, // no retries
                        DefaultRetryPolicy.DEFAULT_BACKOFF_MULT
                ));

                queue.add(request);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
