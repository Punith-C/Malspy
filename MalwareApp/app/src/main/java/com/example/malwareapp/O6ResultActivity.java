package com.example.malwareapp;

import android.Manifest;
import android.content.ContentValues;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.graphics.Color;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.FileOutputStream;
import java.io.OutputStream;

public class O6ResultActivity extends AppCompatActivity {

    private static final int REQUEST_WRITE_STORAGE = 112;

    TextView appNameText, analysisTypeText, verdictText, riskScoreText, actionText, resultView;
    Button downloadBtn;

    String resultJson;
    String verdict = "Unknown";
    double riskScore = -1;
    String recommendedAction = "-";
    String appName = "-";
    String analysisType = "-";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_result);

        // Initialize UI components
        appNameText = findViewById(R.id.appNameText);
        analysisTypeText = findViewById(R.id.analysisTypeText);
        verdictText = findViewById(R.id.verdictText);
        riskScoreText = findViewById(R.id.riskScoreText);
        actionText = findViewById(R.id.actionText);
        resultView = findViewById(R.id.resultView);
        downloadBtn = findViewById(R.id.downloadBtn);

        Intent intent = getIntent();
        resultJson = intent.getStringExtra("resultJson");

        // Check for appName and analysisType passed via Intent extras as fallback
        if (intent.hasExtra("appName")) {
            appName = intent.getStringExtra("appName");
        }
        if (intent.hasExtra("analysisType")) {
            analysisType = intent.getStringExtra("analysisType");
        }

        if (resultJson == null || resultJson.isEmpty()) {
            setFieldsAndColors();
            resultView.setText("⚠ No result data received.");
            return;
        }

        try {
            JSONObject jsonObject = new JSONObject(resultJson);

            // Use backend-returned values if available, else fallback to Intent extras
            appName = jsonObject.optString("app_name", appName);
            analysisType = jsonObject.optString("analysis_type", analysisType);

            verdict = jsonObject.optString("verdict", "Unknown");
            riskScore = jsonObject.optDouble("risk_score", -1);
            recommendedAction = jsonObject.optString("recommended_action", "-");

            // Clean spacing in recommendedAction if needed
            recommendedAction = recommendedAction.replaceAll("([a-z])([A-Z])", "$1 $2");

            setFieldsAndColors();
            resultView.setText(prettifyJson(resultJson));

        } catch (JSONException e) {
            setFieldsAndColors();
            resultView.setText("Raw Result:\n\n" + resultJson);
        }

        downloadBtn.setOnClickListener(v -> checkPermissionAndSave());
    }

    private void setFieldsAndColors() {
        appNameText.setText(appName != null && !appName.isEmpty() ? appName : "-");
        analysisTypeText.setText(analysisType != null && !analysisType.isEmpty() ? analysisType.toUpperCase() : "-");
        verdictText.setText(verdict);
        riskScoreText.setText(riskScore >= 0 ? String.format("%.2f", riskScore) : "-");
        actionText.setText(recommendedAction);

        // Color coding for 5 verdict levels
        if ("benign".equalsIgnoreCase(verdict)) {
            verdictText.setTextColor(Color.parseColor("#4CAF50"));     // green
            actionText.setTextColor(Color.parseColor("#2E7D32"));
        } else if ("adware".equalsIgnoreCase(verdict)) {
            verdictText.setTextColor(Color.parseColor("#FFEB3B"));     // yellow
            actionText.setTextColor(Color.parseColor("#FBC02D"));
        } else if ("spyware".equalsIgnoreCase(verdict)) {
            verdictText.setTextColor(Color.parseColor("#FF9800"));     // orange
            actionText.setTextColor(Color.parseColor("#EF6C00"));
        } else if ("trojan".equalsIgnoreCase(verdict)) {
            verdictText.setTextColor(Color.parseColor("#FF5722"));     // deep orange
            actionText.setTextColor(Color.parseColor("#E64A19"));
        } else if ("ransomware".equalsIgnoreCase(verdict)) {
            verdictText.setTextColor(Color.parseColor("#F44336"));     // red
            actionText.setTextColor(Color.parseColor("#B71C1C"));
        } else {
            verdictText.setTextColor(Color.DKGRAY);
            actionText.setTextColor(Color.DKGRAY);
        }
    }


    private String prettifyJson(String jsonString) {
        try {
            JSONObject json = new JSONObject(jsonString);
            return json.toString(4);
        } catch (JSONException e) {
            return jsonString;
        }
    }

    private void checkPermissionAndSave() {
        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.Q) {
            boolean hasPermission = ContextCompat.checkSelfPermission(this,
                    Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED;
            if (!hasPermission) {
                ActivityCompat.requestPermissions(this,
                        new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE},
                        REQUEST_WRITE_STORAGE);
                return;
            }
        }
        saveReport();
    }

    private void saveReport() {
        try {
            String fileName = "malware_report_" + System.currentTimeMillis() + ".json";
            OutputStream fos;
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                ContentValues values = new ContentValues();
                values.put(MediaStore.Downloads.DISPLAY_NAME, fileName);
                values.put(MediaStore.Downloads.MIME_TYPE, "application/json");
                values.put(MediaStore.Downloads.RELATIVE_PATH, Environment.DIRECTORY_DOWNLOADS);
                Uri uri = getContentResolver().insert(MediaStore.Downloads.EXTERNAL_CONTENT_URI, values);
                fos = getContentResolver().openOutputStream(uri);
            } else {
                String path = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS).getAbsolutePath();
                fos = new FileOutputStream(path + "/" + fileName);
            }
            fos.write(resultJson.getBytes());
            fos.close();
            Toast.makeText(this, "✅ Report saved to Downloads", Toast.LENGTH_LONG).show();
        } catch (Exception e) {
            e.printStackTrace();
            Toast.makeText(this, "❌ Failed to save report", Toast.LENGTH_SHORT).show();
        }
    }

    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions,
                                           @NonNull int[] grantResults) {
        if (requestCode == REQUEST_WRITE_STORAGE) {
            if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                saveReport();
            } else {
                Toast.makeText(this, "Storage permission required to save report", Toast.LENGTH_SHORT).show();
            }
        } else {
            super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        }
    }
}
